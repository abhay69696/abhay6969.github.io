<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>ESP32 Bus Tracker</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 0;
      background-color: #121212;
      color: #fff;
    }
    #map {
      height: 80vh;
      width: 100%;
      filter: invert(90%) hue-rotate(180deg);
    }
    .info, .admin-controls {
      padding: 10px;
      background-color: #1e1e1e;
      border-bottom: 1px solid #333;
    }
    #login {
      margin: 20px;
    }
    input, button {
      padding: 6px;
      margin: 5px;
      border-radius: 5px;
      border: none;
    }
    button {
      cursor: pointer;
      background-color: #333;
      color: white;
    }
    button:hover {
      background-color: #555;
    }
    #stop-list {
      padding: 10px;
      background-color: #1e1e1e;
      max-height: 20vh;
      overflow-y: auto;
    }
    .stop-item {
      margin-bottom: 5px;
    }
    .dropdown {
      width: 100%;
      padding: 10px;
      background-color: #333;
      color: white;
      border-radius: 5px;
      border: none;
    }
    .dropdown:hover {
      background-color: #444;
    }
  </style>
</head>
<body>

<div id="login">
  <label for="password">Enter Admin Password:</label>
  <input type="password" id="password" />
  <button onclick="checkAdminPassword()">Login</button>
</div>

<div class="info">
  <strong>Speed:</strong> <span id="speed">--</span> km/h |
  <strong>Destination:</strong> <span id="destination">--</span> |
  <strong>Total ETA:</strong> <span id="total-eta">--</span> mins |
  <strong>Total Distance:</strong> <span id="total-distance">--</span> km |
  <strong>Current Stop:</strong> <span id="current-stop">--</span>
</div>

<div id="map"></div>

<div id="stop-list"></div>

<div class="admin-controls" style="display:none">
  <button onclick="toggleRouteStyles()">Toggle Route Style</button>
  <button onclick="toggleSimulationMode()">Switch Simulation Mode</button>
 <div>
  <label for="stop-name">Enter Stop Name:</label>
  <input type="text" id="stop-name" placeholder="Stop Name">
  <button onclick="addStopByName()">Add Stop by Name</button>
</div>
  <div>
    <p>Click on the map to add a stop.</p>
    <button onclick="alert('Click anywhere on the map to add a stop.')">Click on the map to add a stop</button>
  </div>
</div>

<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script>
let isAdmin = false;
const adminPassword = "123";
const openRouteKey = "5b3ce3597851110001cf62485b10dc97ee1248659a73278c239b3c61";
const nitte = { name: "Nitte", lat: 13.1681, lon: 74.9331 };
const mangalore = { name: "Mangalore", lat: 12.9141, lon: 74.8560 };
let destination = mangalore;
let origin = nitte;
let simulationMode = true;
let map = L.map('map').setView([13.06, 74.80], 14);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { maxZoom: 18 }).addTo(map);
let busIcon = L.icon({ iconUrl: 'https://cdn-icons-png.flaticon.com/512/296/296216.png', iconSize: [40, 40], iconAnchor: [20, 20], popupAnchor: [0, -15] });
let busMarker = L.marker([origin.lat, origin.lon], { icon: busIcon }).addTo(map);
let routePoints = [], currentRouteIndex = 0, polyline = null, simulationInterval = null;
let stops = JSON.parse(localStorage.getItem("stops")) || [origin, destination];
let passedStops = [];
L.marker([nitte.lat, nitte.lon]).addTo(map).bindPopup("Start/End: Nitte");
L.marker([mangalore.lat, mangalore.lon]).addTo(map).bindPopup("Start/End: Mangalore");
map.on('click', function (e) {
  if (!isAdmin) {
    alert("Only admins can add stops.");
    return;
  }

  const { lat, lng } = e.latlng;
  const stopName = prompt("Enter a name for this stop:");
  if (!stopName) return;

  const newStop = { name: stopName, lat, lon: lng };
  stops.splice(stops.length - 1, 0, newStop); // Add before destination
  localStorage.setItem("stops", JSON.stringify(stops));
  L.marker([lat, lng]).addTo(map).bindPopup(`Stop: ${stopName}`).openPopup();
  getFullRoute();
});
function checkAdminPassword() {
  const enteredPassword = document.getElementById('password').value;
  if (enteredPassword === adminPassword) {
    isAdmin = true;
    document.getElementById('login').style.display = 'none';
    document.querySelector('.admin-controls').style.display = 'block';
    alert("Welcome, Admin!");
  } else {
    alert("Incorrect password.");
  }
}

function toggleSimulationMode() {
  if (!isAdmin) return;
  simulationMode = !simulationMode;
  alert("Simulation Mode: " + simulationMode);
  if (simulationMode) {
    getFullRoute();
  } else {
    if (simulationInterval) clearInterval(simulationInterval);
    fetchRealData();
  }
}

function fetchRealData() {
  fetch("https://api.thingspeak.com/channels/2926249/feeds.json?results=1")
    .then(res => res.json())
    .then(data => {
      const feed = data.feeds[0];
      const lat = parseFloat(feed.field1);
      const lon = parseFloat(feed.field2);
      busMarker.setLatLng([lat, lon]);
      updateStopList(lat, lon);
      updateETA(lat, lon);
    })
    .catch(console.error);
  setTimeout(fetchRealData, 5000);
}


function updateETA(lat, lon) {
  fetch(`https://api.openrouteservice.org/v2/directions/driving-car?api_key=${openRouteKey}&start=${lon},${lat}&end=${destination.lon},${destination.lat}`)
    .then(res => res.json())
    .then(data => {
      const duration = data.features[0].properties.summary.duration;
      const minutes = Math.round(duration / 60);
      document.getElementById('total-eta').textContent = `${minutes}`;
      updateStopETAs(lat, lon);
    })
    .catch(console.error);
}

let arrivalTimes = []; // Store the last known ETA for each stop
let lastUpdateTimes = []; // Track the time of the last update for each stop

function updateStopETAs(lat, lon) {
  const now = new Date();

  stops.forEach((stop, index) => {
    if (passedStops.includes(index)) return; // Skip passed stops

    // Throttle updates: Only update if 30 seconds have passed since the last update
    if (lastUpdateTimes[index] && (now - lastUpdateTimes[index]) < 30000) {
      const etaElem = document.getElementById(`eta-stop-${index}`);
      if (etaElem && arrivalTimes[index]) {
        etaElem.textContent = arrivalTimes[index]; // Display the last stored ETA
      }
      return; // Skip fetching and updating if the time since the last update is less than 30 seconds
    }

    // Fetch new ETA data
    fetch(`https://api.openrouteservice.org/v2/directions/driving-car?api_key=${openRouteKey}&start=${lon},${lat}&end=${stop.lon},${stop.lat}`)
      .then(res => res.json())
      .then(data => {
        const durationSec = data.features[0].properties.summary.duration; // Duration in seconds
        const arrival = new Date(now.getTime() + durationSec * 1000); // Calculate arrival time
        const arrivalTimeStr = arrival.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });

        // Update only if the arrival time has changed
        if (arrivalTimes[index] !== arrivalTimeStr) {
          arrivalTimes[index] = arrivalTimeStr;
          lastUpdateTimes[index] = now; // Update the last update time

          // Update the ETA in the UI
          const etaElem = document.getElementById(`eta-stop-${index}`);
          if (etaElem) {
            etaElem.textContent = arrivalTimes[index];
          }
        }
      })
      .catch((error) => {
        console.error(`Error fetching ETA for stop ${stop.name}:`, error);
      });
  });
}


function getFullRoute() {
  if (stops.length < 2) return;
  const coordinates = stops.map(s => [s.lon, s.lat]);
  fetch(`https://api.openrouteservice.org/v2/directions/driving-car/geojson`, {
    method: "POST",
    headers: { "Authorization": openRouteKey, "Content-Type": "application/json" },
    body: JSON.stringify({ coordinates })
  })
  .then(res => res.json())
  .then(data => {
    routePoints = data.features[0].geometry.coordinates.map(c => [c[1], c[0]]);
    currentRouteIndex = 0;
    if (polyline) polyline.remove();
    polyline = L.polyline(routePoints, { color: 'blue', weight: 3 }).addTo(map);
    busMarker.setLatLng(routePoints[0]);
    calculateTotalDistance();
    updateStopList(routePoints[0][0], routePoints[0][1]);
    if (simulationInterval) clearInterval(simulationInterval);
    simulationInterval = setInterval(moveBusAlongRoute, 1000);
  })
  .catch(console.error);
}

function calculateTotalDistance() {
  let totalDistance = 0;
  for (let i = 0; i < routePoints.length - 1; i++) {
    totalDistance += getDistance(routePoints[i][0], routePoints[i][1], routePoints[i + 1][0], routePoints[i + 1][1]);
  }
  document.getElementById('total-distance').textContent = totalDistance.toFixed(2);
}

function moveBusAlongRoute() {
  if (routePoints.length === 0) return;
  const nextPoint = routePoints[currentRouteIndex];
  const currentPos = busMarker.getLatLng();
  const lat = currentPos.lat + (nextPoint[0] - currentPos.lat) * 0.2;
  const lng = currentPos.lng + (nextPoint[1] - currentPos.lng) * 0.2;
  busMarker.setLatLng([lat, lng]);
  const dist = getDistance(lat, lng, nextPoint[0], nextPoint[1]);
  if (dist < 0.03) currentRouteIndex++;
  if (currentRouteIndex >= routePoints.length) currentRouteIndex = 0;
  document.getElementById('speed').textContent = Math.floor(30 + Math.random() * 70);
  updateStopList(lat, lng);
  updateETA(lat, lng);
}

function toRad(deg) { return deg * Math.PI / 180; }

function getDistance(lat1, lon1, lat2, lon2) {
  const R = 6371; 
  const dLat = toRad(lat2 - lat1);
  const dLon = toRad(lon2 - lon1);
  const a = Math.sin(dLat / 2) ** 2 + Math.cos(toRad(lat1)) * Math.cos(toRad(lat2)) * Math.sin(dLon / 2) ** 2;
  return 2 * R * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
}

function updateStopList(lat, lon) {
  let stopListHtml = `
    <table style="width: 100%; border-collapse: collapse; color: white;">
      <thead>
        <tr style="background-color: #333;">
          <th style="padding: 8px; border: 1px solid #444;">Stop Name</th>
          <th style="padding: 8px; border: 1px solid #444;">Distance (km)</th>
          <th style="padding: 8px; border: 1px solid #444;">ETA</th>
          <th style="padding: 8px; border: 1px solid #444;">Status</th>
          <th style="padding: 8px; border: 1px solid #444;">Actions</th>
        </tr>
      </thead>
      <tbody>
  `;

  stops.forEach((stop, index) => {
    const dist = getDistance(lat, lon, stop.lat, stop.lon);
    const isPassed = passedStops.includes(index);
    stopListHtml += `
      <tr style="background-color: ${isPassed ? '#222' : '#1e1e1e'};">
        <td style="padding: 8px; border: 1px solid #444;">${stop.name}</td>
        <td style="padding: 8px; border: 1px solid #444;">${dist.toFixed(2)}</td>
        <td style="padding: 8px; border: 1px solid #444;" id="eta-stop-${index}">--</td>
        <td style="padding: 8px; border: 1px solid #444;">${isPassed ? 'Passed' : 'Upcoming'}</td>
        <td style="padding: 8px; border: 1px solid #444;">
          <button onclick="removeStop(${index})" style="background-color: red; color: white; border: none; padding: 5px; border-radius: 3px; cursor: pointer;">Remove</button>
        </td>
      </tr>
    `;
  });

  stopListHtml += `
      </tbody>
    </table>
  `;

  document.getElementById("stop-list").innerHTML = stopListHtml;
}

function addStopByName() {
  const stopName = document.getElementById("stop-name").value.trim();
  if (!stopName) return;
  const newStop = { name: stopName, lat: 13.0 + Math.random(), lon: 74.0 + Math.random() }; // Simulated coordinates
  stops.splice(stops.length - 1, 0, newStop); // Add before destination
  localStorage.setItem("stops", JSON.stringify(stops));
  getFullRoute();
}

function clearAllStops() {
  stops = [origin, destination];
  localStorage.setItem("stops", JSON.stringify(stops));
  getFullRoute();
}

function removeStop(index) {
  if (index === 0 || index === stops.length - 1) {
    alert("You cannot remove the origin or destination stop.");
    return;
  }

  stops.splice(index, 1); // Remove the stop at the specified index
  localStorage.setItem("stops", JSON.stringify(stops)); // Update local storage
  getFullRoute(); // Recalculate the route
}
</script>

</body>
</html>
